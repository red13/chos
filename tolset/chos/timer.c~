#include <stdio.h>
#include <string.h>
#include "bootpack.h"
#include "int.h"
#include "timer.h"

int init_timer_manager( MEMMAN* mm, timer_manager_t** tm )
{
	timer_manager_t* t;

	t = (timer_manager_t*)memman_alloc_4k( mm, sizeof(timer_manager_t) );
	if( t == 0 ){
		return -1;
	}

	t->list.head = NULL;
	t->list.tail = NULL;
	t->list.num = 0;
	
	memset( t->buf, 0, sizeof(timer_list_t) * TIMER_MAX );

	*tm = t;

	return 0;
}

int add_timer( timer_manager_t* tm, timer_t* t )
{
	timer_list_t* cur;
	int i;
	unsigned long now;

	if( tm->list.num >= TIMER_MAX ){
		return -1;
	}

	now = get_systime();

	if( tm->list.head == NULL ){
		tm->buf[0].prev = NULL;
		tm->buf[0].next = NULL;
		tm->buf[0].valid = 1;
		tm->buf[0].t.timeout = t->timeout;
		tm->buf[0].t.func = t->func;
		tm->buf[0].t.param = t->param;
		tm->list.head = &tm->buf[0];
		tm->list.tail = &tm->buf[0];
		tm->list.num = 1;
	}else{
		for( i = 0; i < TIMER_MAX; i++ ){
			if( tm->buf[i].valid == 0 ){
				/* ‘}“ü‚·‚éêŠ‚ð‚Ý‚Â‚¯‚½ */
				break;
			}
		}
		if( i == TIMER_MAX ){
			return -1;
		}
		for( cur = tm->list.head; cur->next != NULL; cur = cur->next ){
			if((int)(t->timeout - now) < (cur->t.timeout - now)){
				
				tm->buf[i].prev = cur->prev;
				tm->buf[i].next = cur;
				tm->buf[i].valid = 1;
				tm->buf[i].t.timeout = t->timeout;
				tm->buf[i].t.func = t->func;
				tm->buf[i].t.param = t->param;
				if( cur->prev == NULL ){
					tm->list.head = &tm->buf[i];
				}else{
					cur->prev->next = &tm->buf[i];
				}
			}
		}
		if( cur->next == NULL ){
			/* I’[‚É’Ç‰Á‚·‚é‚Æ‚« */
			tm->buf[i].prev = cur;
			tm->buf[i].next = NULL;
			tm->buf[i].valid = 1;
			tm->buf[i].t.timeout = t->timeout;
			tm->buf[i].t.func = t->func;
			tm->buf[i].t.param = t->param;
			cur->next = &tm->buf[i];
		}
	}

	return 0;
}

